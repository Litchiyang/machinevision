clear;
close all

% load all the images into dataset
%global apple;

D = dir(fullfile('Apple_test','*JPG'));
fprintf('loading %02d',length(D));

%apple = cell(21,1);

for i = 1:length(D)
    fprintf('\b\b%02d',i);
end
fprintf('\n');

%clear D;
% end of load images



%function openbw=ObjectDetection()

mean_list = zeros(4,length(D));  % create mean values for each apple slice
% loop over all the images in the folder
for k = 1:length(D)
    src = imread(D(k).name);
    %src = imread('1_1600_1.JPG');
    row = size(src,1);
    col = size(src,2);
    src1 = rgb2gray(src); % convert the original image into black/white

    src2 = medfilt2(src1,[5 5]); %convolution with image with kernel size 5*5
    %imshow(src2)

    level = graythresh(src2); %calculating threshold
    bw = im2bw(src,level); %binarization image
    %imshow(bw)


    se = strel('square',2); %create a 2*2 square
    openbw = imopen(bw,se); %smooth the edge 

    stats = regionprops(openbw,'basic'); %get Area,Centroid,BoundingBox of the connected image

    centroids = cat(1,stats.Centroid);


    area = cat(1,stats.Area);
    area = sort(area,'descend');
    apple1 = area(2); %first apple
    apple2 = area(3); %second apple
    apple3 = area(4); %third apple
    apple4 = area(5); %forth apple
    centroidsOfficiall = [];
    boundingBox = [];
    list = [];


    for i=1:size(stats) 
        if stats(i).Area==apple1 | stats(i).Area==apple2 |stats(i).Area==apple3 |stats(i).Area==apple4
         %centroidsOfficiall = [centroidsOfficiall,stats(i).Centroid]
         %   boundingBox = [[boundingBox] [stats(i).BoundingBox]]
         list = [list,i];
        end
    end


    imshow(openbw),title('centroids')
    hold on

    %plot(centroids(:,1),centroids(:,2),'b*'),

    for i=1:size(list,2)
        a = stats(list(i)).Centroid;
        plot(a(1),a(2),'b*');
        rectangle('Position',stats(list(i)).BoundingBox,'LineWidth',2,'LineStyle','--','EdgeColor','r');

        % get five target windows around the centroids
        ax = round(a(1)-50);
        ay = round(a(2)-50);
        rectangle('Position', [ax ay 101 101], 'LineWidth',1,'LineStyle','-','EdgeColor','r');
        aax = ax - 101;
        aay = ay;
        rectangle('Position', [aax aay 101 101], 'LineWidth',1,'LineStyle','-','EdgeColor','r');
        abx = ax + 101;
        aby = ay;
        rectangle('Position', [abx aby 101 101], 'LineWidth',1,'LineStyle','-','EdgeColor','r');
        alx = ax;
        aly = ay - 101;
        rectangle('Position', [alx aly 101 101], 'LineWidth',1,'LineStyle','-','EdgeColor','r');
        arx = ax;
        ary = ay + 101;
        rectangle('Position', [arx ary 101 101], 'LineWidth',1,'LineStyle','-','EdgeColor','r');

        R_m = [];
        G_m = [];
        B_m = [];
        
        R_a = [];
        G_a = [];
        B_a = [];
        
        R_b = [];
        G_b = [];
        B_b = [];
        
        R_l = [];
        G_l = [];
        B_l = [];
        
        R_r = [];
        G_r = [];
        B_r = [];
        
        mean_red = zeros(5);
        mean_green = zeros(5);
        mean_blue = zeros(5);
       

        if max(ax,row)==row & min(ax-101,1)==1 & max(ay+101,col)==col & min(ay,1)==1
            color = src(((ax-101):ax), (ay:ay+101), :);
            R_m = color(:, :, 1);
            G_m = color(:, :, 2);
            B_m = color(:, :, 3);
            mean_red(5) = mean2(R_m);
            mean_green(5) = mean2(G_m);
            mean_blue(5) = mean2(B_m);
  
        end
        
        if max(aax,row)==row & min(aax-101,1)==1 & max(aay+101,col)==col & min(aay,1)==1
            color = src(((aax-101):aax), (aay:aay+101), :);
            R_a = color(:, :, 1);
            G_a = color(:, :, 2);
            B_a = color(:, :, 3);
            mean_red(1) = mean2(R_a);
            mean_green(1) = mean2(G_a);
            mean_blue(1) = mean2(B_a);
        end
        
        if max(abx,row)==row & min(abx-101,1)==1 & max(aby+101,col)==col & min(aby,1)==1
            color = src(((abx-101):abx), (aby:aby+101), :);
            R_b = color(:, :, 1);
            G_b = color(:, :, 2);
            B_b = color(:, :, 3);
            mean_red(2) = mean2(R_b);
            mean_green(2) = mean2(G_b);
            mean_blue(2) = mean2(B_b);
        end
        
        if max(alx,row)==row & min(alx-101,1)==1 & max(aly+101,col)==col & min(aly,1)==1
            color  = src(((alx-101):alx), (aly:aly+101), :);
            R_l = color(:, :, 1);
            G_l = color(:, :, 2);
            B_l = color(:, :, 3);
            mean_red(3) = mean2(R_l);
            mean_green(3) = mean2(G_l);
            mean_blue(3) = mean2(B_l);

        end
        
        if max(arx,row)==row & min(arx-101,1)==1 & max(ary+101,col)==col & min(ary,1)==1
            color = src(((arx-101):arx), (ary:ary+101), :);
            R_r = color(:, :, 1);
            G_r = color(:, :, 2);
            B_r = color(:, :, 3);
            mean_red(4) = mean2(R_r);
            mean_green(4) = mean2(G_r);
            mean_blue(4) = mean2(B_r);
        end
        
        mean_r = (mean_red(1)+mean_red(2)+mean_red(3)+mean_red(4)+mean_red(5))/5;
        mean_g = (mean_green(1)+mean_green(2)+mean_green(3)+mean_green(4)+mean_green(5))/5;
        mean_b = (mean_blue(1)+mean_blue(2)+mean_blue(3)+mean_blue(4)+mean_blue(5))/5;
        
        R = [R_m R_a R_b R_l R_r];
        G = [G_m G_a G_b G_l G_r];
        B = [B_m B_a B_b B_l B_r];
        
        std_red = std2(R);
        std_green = std2(G);
        std_blue = std2(B);

       fprintf('mean of R, G, B: %f, %f, %f\n', mean_r, mean_g, mean_b);
       fprintf('standard deviation of R, G, B: %f, %f, %f\n', std_red, std_green, std_blue);
        
    end
    hold off
    %}

end